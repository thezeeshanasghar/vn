name: Deploy to EC2

on:
  push:
    branches:
      - master
    paths:
      - 'admin/**'
      - 'doctor/**'
      - 'patient/**'
      - 'pa/**'
      - 'stock/**'
      - 'backend/**'
      - 'docker-compose.yml'
      - '.github/workflows/**'  # Trigger on workflow changes
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to EC2 Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch current and previous commit to detect changes

      - name: Detect changed services
        id: changes
        run: |
          echo "Detecting which services changed..."
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Initialize flags
          REBUILD_ADMIN=false
          REBUILD_DOCTOR=false
          REBUILD_PATIENT=false
          REBUILD_PA=false
          REBUILD_STOCK=false
          REBUILD_BACKEND=false
          REBUILD_ALL=false
          
          # Check which services were modified
          if echo "$CHANGED_FILES" | grep -q "^admin/"; then
            REBUILD_ADMIN=true
            echo "‚úÖ Admin changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^doctor/"; then
            REBUILD_DOCTOR=true
            echo "‚úÖ Doctor changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^patient/"; then
            REBUILD_PATIENT=true
            echo "‚úÖ Patient changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^pa/"; then
            REBUILD_PA=true
            echo "‚úÖ PA changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^stock/"; then
            REBUILD_STOCK=true
            echo "‚úÖ Stock changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^backend/"; then
            REBUILD_BACKEND=true
            echo "‚úÖ Backend changed"
          fi
          
          # If docker-compose.yml changed, rebuild everything
          if echo "$CHANGED_FILES" | grep -q "^docker-compose.yml"; then
            REBUILD_ALL=true
            echo "‚ö†Ô∏è Docker Compose changed - will rebuild all services"
          fi
          
          # Export variables
          echo "rebuild_admin=$REBUILD_ADMIN" >> $GITHUB_OUTPUT
          echo "rebuild_doctor=$REBUILD_DOCTOR" >> $GITHUB_OUTPUT
          echo "rebuild_patient=$REBUILD_PATIENT" >> $GITHUB_OUTPUT
          echo "rebuild_pa=$REBUILD_PA" >> $GITHUB_OUTPUT
          echo "rebuild_stock=$REBUILD_STOCK" >> $GITHUB_OUTPUT
          echo "rebuild_backend=$REBUILD_BACKEND" >> $GITHUB_OUTPUT
          echo "rebuild_all=$REBUILD_ALL" >> $GITHUB_OUTPUT

      - name: Setup SSH Key
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH key from GitHub Secrets
          echo "Using SSH key from GitHub Secrets..."
          # Use printf to preserve newlines properly
          printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/key.pem
          
          # Validate key file exists and has content
          if [ ! -s ~/.ssh/key.pem ]; then
            echo "‚ùå Error: SSH key file is empty or missing"
            exit 1
          fi
          
          # Set proper permissions
          chmod 600 ~/.ssh/key.pem
          
          # Verify key format
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/key.pem; then
            echo "‚ùå Error: SSH key format appears invalid"
            exit 1
          fi
          
          echo "‚úÖ SSH key file created successfully"
          
          # Add EC2 host to known_hosts (with retry logic)
          echo "Adding EC2 host to known_hosts..."
          if ! ssh-keyscan -H 13.203.238.30 >> ~/.ssh/known_hosts 2>&1; then
            echo "‚ö†Ô∏è Warning: ssh-keyscan failed, but continuing..."
          fi
          
          chmod 644 ~/.ssh/known_hosts
          echo "‚úÖ SSH setup completed"

      - name: Deploy to EC2
        env:
          EC2_HOST: 13.203.238.30
          EC2_USER: ec2-user
          REBUILD_ADMIN: ${{ steps.changes.outputs.rebuild_admin }}
          REBUILD_DOCTOR: ${{ steps.changes.outputs.rebuild_doctor }}
          REBUILD_PATIENT: ${{ steps.changes.outputs.rebuild_patient }}
          REBUILD_PA: ${{ steps.changes.outputs.rebuild_pa }}
          REBUILD_STOCK: ${{ steps.changes.outputs.rebuild_stock }}
          REBUILD_BACKEND: ${{ steps.changes.outputs.rebuild_backend }}
          REBUILD_ALL: ${{ steps.changes.outputs.rebuild_all }}
        run: |
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << EOF
            set -e
            
            echo "üöÄ Starting selective deployment..."
            
            # Navigate to project directory
            mkdir -p /home/ec2-user/vn
            cd /home/ec2-user/vn
            
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/master
            
            # Build list of services to rebuild
            SERVICES_TO_REBUILD=""
            
            if [ "$REBUILD_ALL" = "true" ]; then
              echo "‚ö†Ô∏è Rebuilding ALL services (docker-compose.yml changed)"
              docker-compose down
              docker-compose up -d --build
            else
              echo "üéØ Rebuilding only changed services..."
              
              if [ "$REBUILD_BACKEND" = "true" ]; then
                echo "üîÑ Rebuilding Backend..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD backend"
              fi
              
              if [ "$REBUILD_ADMIN" = "true" ]; then
                echo "üîÑ Rebuilding Admin System..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD admin-system"
              fi
              
              if [ "$REBUILD_DOCTOR" = "true" ]; then
                echo "üîÑ Rebuilding Doctor Portal..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD doctor-portal"
              fi
              
              if [ "$REBUILD_PATIENT" = "true" ]; then
                echo "üîÑ Rebuilding Patient Panel..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD patient-panel"
              fi
              
              if [ "$REBUILD_PA" = "true" ]; then
                echo "üîÑ Rebuilding PA Portal..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD pa-portal"
              fi
              
              if [ "$REBUILD_STOCK" = "true" ]; then
                echo "üîÑ Rebuilding Stock Portal..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD stock-portal"
              fi
              
              # Rebuild only changed services
              if [ -n "\$SERVICES_TO_REBUILD" ]; then
                echo "üì¶ Services to rebuild:\$SERVICES_TO_REBUILD"
                docker-compose up -d --build\$SERVICES_TO_REBUILD
              else
                echo "‚ÑπÔ∏è No services to rebuild"
              fi
            fi
            
            echo "üßπ Cleaning up unused Docker images..."
            docker image prune -af --filter "until=24h"
            
            echo "‚úÖ Deployment completed successfully!"
            
            echo "üìä Container status:"
            docker-compose ps
          EOF

      - name: Verify Deployment
        env:
          EC2_HOST: 13.203.238.30
          EC2_USER: ec2-user
        run: |
          ssh -i ~/.ssh/key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
            echo "üîç Checking service health..."
            
            # Get the machine's private IP
            PRIVATE_IP=$(hostname -I | awk '{print $1}')
            echo "Machine IP: $PRIVATE_IP"
            
            # Wait for services to start
            sleep 15
            
            # Check if backend is responding
            echo "Testing Backend API..."
            curl -f http://0.0.0.0:3000/api/health || curl -f http://$PRIVATE_IP:3000/api/health || echo "‚ö†Ô∏è Backend health check failed"
            
            # Check frontend applications
            echo "Testing Admin System..."
            curl -f http://0.0.0.0:8081/health || echo "‚ö†Ô∏è Admin health check failed"
            
            echo "Testing Doctor Portal..."
            curl -f http://0.0.0.0:8082/ || echo "‚ö†Ô∏è Doctor health check failed"
            
            echo "Testing Patient Panel..."
            curl -f http://0.0.0.0:8083/ || echo "‚ö†Ô∏è Patient health check failed"
            
            echo "Testing PA Portal..."
            curl -f http://0.0.0.0:8084/health || echo "‚ö†Ô∏è PA health check failed"
            
            echo "Testing Stock Portal..."
            curl -f http://0.0.0.0:8085/health || echo "‚ö†Ô∏è Stock health check failed"
            
            # Check running containers
            echo ""
            echo "Running containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          EOF

      - name: Cleanup SSH Key
        if: always()
        run: |
          rm -f ~/.ssh/key.pem

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Deployment to EC2 completed successfully!"
          echo "üåê Access your applications at:"
          echo "  - Admin: http://13.203.238.30:8081"
          echo "  - Doctor: http://13.203.238.30:8082"
          echo "  - Patient: http://13.203.238.30:8083"
          echo "  - PA: http://13.203.238.30:8084"
          echo "  - Stock: http://13.203.238.30:8085"
          echo "  - MongoDB UI: http://13.203.238.30:8086"
          echo "  - Backend API: http://13.203.238.30:3000"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Please check the logs above."

