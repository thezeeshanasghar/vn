name: Deploy to EC2

on:
  push:
    branches:
      - master
    paths:
      - 'admin/**'
      - 'doctor/**'
      - 'patient/**'
      - 'pa/**'
      - 'stock/**'
      - 'backend/**'
      - 'docker-compose.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to EC2 Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch current and previous commit to detect changes

      - name: Detect changed services
        id: changes
        run: |
          echo "Detecting which services changed..."
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Initialize flags
          REBUILD_ADMIN=false
          REBUILD_DOCTOR=false
          REBUILD_PATIENT=false
          REBUILD_PA=false
          REBUILD_STOCK=false
          REBUILD_BACKEND=false
          REBUILD_ALL=false
          
          # Check which services were modified
          if echo "$CHANGED_FILES" | grep -q "^admin/"; then
            REBUILD_ADMIN=true
            echo "âœ… Admin changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^doctor/"; then
            REBUILD_DOCTOR=true
            echo "âœ… Doctor changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^patient/"; then
            REBUILD_PATIENT=true
            echo "âœ… Patient changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^pa/"; then
            REBUILD_PA=true
            echo "âœ… PA changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^stock/"; then
            REBUILD_STOCK=true
            echo "âœ… Stock changed"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^backend/"; then
            REBUILD_BACKEND=true
            echo "âœ… Backend changed"
          fi
          
          # If docker-compose.yml changed, rebuild everything
          if echo "$CHANGED_FILES" | grep -q "^docker-compose.yml"; then
            REBUILD_ALL=true
            echo "âš ï¸ Docker Compose changed - will rebuild all services"
          fi
          
          # Export variables
          echo "rebuild_admin=$REBUILD_ADMIN" >> $GITHUB_OUTPUT
          echo "rebuild_doctor=$REBUILD_DOCTOR" >> $GITHUB_OUTPUT
          echo "rebuild_patient=$REBUILD_PATIENT" >> $GITHUB_OUTPUT
          echo "rebuild_pa=$REBUILD_PA" >> $GITHUB_OUTPUT
          echo "rebuild_stock=$REBUILD_STOCK" >> $GITHUB_OUTPUT
          echo "rebuild_backend=$REBUILD_BACKEND" >> $GITHUB_OUTPUT
          echo "rebuild_all=$REBUILD_ALL" >> $GITHUB_OUTPUT

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem
          ssh-keyscan -H 15.206.122.138 >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: 15.206.122.138
          EC2_USER: ec2-user
          REBUILD_ADMIN: ${{ steps.changes.outputs.rebuild_admin }}
          REBUILD_DOCTOR: ${{ steps.changes.outputs.rebuild_doctor }}
          REBUILD_PATIENT: ${{ steps.changes.outputs.rebuild_patient }}
          REBUILD_PA: ${{ steps.changes.outputs.rebuild_pa }}
          REBUILD_STOCK: ${{ steps.changes.outputs.rebuild_stock }}
          REBUILD_BACKEND: ${{ steps.changes.outputs.rebuild_backend }}
          REBUILD_ALL: ${{ steps.changes.outputs.rebuild_all }}
        run: |
          ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << EOF
            set -e
            
            echo "ðŸš€ Starting selective deployment..."
            
            # Navigate to project directory
            cd /home/ec2-user/vn
            
            echo "ðŸ“¥ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/master
            
            # Build list of services to rebuild
            SERVICES_TO_REBUILD=""
            
            if [ "$REBUILD_ALL" = "true" ]; then
              echo "âš ï¸ Rebuilding ALL services (docker-compose.yml changed)"
              docker-compose down
              docker-compose up -d --build
            else
              echo "ðŸŽ¯ Rebuilding only changed services..."
              
              if [ "$REBUILD_BACKEND" = "true" ]; then
                echo "ðŸ”„ Rebuilding Backend..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD backend"
              fi
              
              if [ "$REBUILD_ADMIN" = "true" ]; then
                echo "ðŸ”„ Rebuilding Admin System..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD admin-system"
              fi
              
              if [ "$REBUILD_DOCTOR" = "true" ]; then
                echo "ðŸ”„ Rebuilding Doctor Portal..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD doctor-portal"
              fi
              
              if [ "$REBUILD_PATIENT" = "true" ]; then
                echo "ðŸ”„ Rebuilding Patient Panel..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD patient-panel"
              fi
              
              if [ "$REBUILD_PA" = "true" ]; then
                echo "ðŸ”„ Rebuilding PA Portal..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD pa-portal"
              fi
              
              if [ "$REBUILD_STOCK" = "true" ]; then
                echo "ðŸ”„ Rebuilding Stock Portal..."
                SERVICES_TO_REBUILD="\$SERVICES_TO_REBUILD stock-portal"
              fi
              
              # Rebuild only changed services
              if [ -n "\$SERVICES_TO_REBUILD" ]; then
                echo "ðŸ“¦ Services to rebuild:\$SERVICES_TO_REBUILD"
                docker-compose up -d --build\$SERVICES_TO_REBUILD
              else
                echo "â„¹ï¸ No services to rebuild"
              fi
            fi
            
            echo "ðŸ§¹ Cleaning up unused Docker images..."
            docker image prune -af --filter "until=24h"
            
            echo "âœ… Deployment completed successfully!"
            
            echo "ðŸ“Š Container status:"
            docker-compose ps
          EOF

      - name: Verify Deployment
        env:
          EC2_HOST: 15.206.122.138
          EC2_USER: ec2-user
        run: |
          ssh -i ~/.ssh/key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
            echo "ðŸ” Checking service health..."
            
            # Get the machine's private IP
            PRIVATE_IP=$(hostname -I | awk '{print $1}')
            echo "Machine IP: $PRIVATE_IP"
            
            # Wait for services to start
            sleep 15
            
            # Check if backend is responding
            echo "Testing Backend API..."
            curl -f http://0.0.0.0:3000/api/health || curl -f http://$PRIVATE_IP:3000/api/health || echo "âš ï¸ Backend health check failed"
            
            # Check frontend applications
            echo "Testing Admin System..."
            curl -f http://0.0.0.0:8081/health || echo "âš ï¸ Admin health check failed"
            
            echo "Testing Doctor Portal..."
            curl -f http://0.0.0.0:8082/ || echo "âš ï¸ Doctor health check failed"
            
            echo "Testing Patient Panel..."
            curl -f http://0.0.0.0:8083/ || echo "âš ï¸ Patient health check failed"
            
            echo "Testing PA Portal..."
            curl -f http://0.0.0.0:8084/health || echo "âš ï¸ PA health check failed"
            
            echo "Testing Stock Portal..."
            curl -f http://0.0.0.0:8085/health || echo "âš ï¸ Stock health check failed"
            
            # Check running containers
            echo ""
            echo "Running containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          EOF

      - name: Cleanup SSH Key
        if: always()
        run: |
          rm -f ~/.ssh/key.pem

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Deployment to EC2 completed successfully!"
          echo "ðŸŒ Access your applications at:"
          echo "  - Admin: http://15.206.122.138:8081"
          echo "  - Doctor: http://15.206.122.138:8082"
          echo "  - Patient: http://15.206.122.138:8083"
          echo "  - PA: http://15.206.122.138:8084"
          echo "  - Stock: http://15.206.122.138:8085"
          echo "  - MongoDB UI: http://15.206.122.138:8086"
          echo "  - Backend API: http://15.206.122.138:3000"

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Please check the logs above."

